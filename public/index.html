<!doctype html>
<html>
<head>
  <title>iKnow! Memory Game</title>
  <meta charset="utf-8" />
  <link href="images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" />

  <!-- Styles -->
  <link href="styles/base.css" media="all" rel="stylesheet" type="text/css">
</head>
<body>
  <header class="header">
    <div class="inner-container">
      <div class="logo-iknow"></div>
    </div>
  </header>

  <div class="primary-content inner-container">
    <!-- Put inner content here -->
    <div id="timer"></div>
    <div id="flipCounter"></div>
    <div id="score"></div>
    <ul class="board">
      
    </ul>

  </div>
  <script type="text/javascript" src="scripts/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="scripts/jquery.flip.min.js"></script>
  <script type="text/javascript" src="scripts/main.js"></script>
  <script type="text/javascript">
    $.getJSON( "api/goal.js", function( data ) {

      var board = initializeBoard(8, data.goal_items);
      var start = Date.now();
      var elapsedTime = {};
      var flipCounter = 0;
      var matches = 0;

      renderBoard(board);
      $('.square:nth-child('+board.size+'n)').next().css({'clear': 'both'});
      $(".square").flip();
      setInterval(function(){
        elapsedTime = getElapsedTime(start);
        $("#timer").text("Time elapsed: "+elapsedTime.mins+" minutes, "+elapsedTime.secs+" seconds");
        // $("#score").text("Score: "+calculateScore(elapsedTime.secs+60*elapsedTime.mins, flipCounter));
      }, 1000);
      $(".square").on('click',function(){
        flipCounter += 1;
        $("#flipCounter").text(flipCounter);
        if (!this.matched){
          currentlyFlipped.push(this);
        }
        if (currentlyFlipped.length === 2){
          if (currentlyFlipped[0].id === currentlyFlipped[1].id){
            if (currentlyFlipped[0].dataset.language !== currentlyFlipped[1].dataset.language){
              currentlyFlipped.forEach(function(card){
                $(card).off(".flip");
                card.matched = true;
              });
              matches += 1;
            }
            currentlyFlipped = [];
          }
          else{ // not match -> flip back
            setTimeout(function(){
              currentlyFlipped.forEach(function(card){
                if (!card.matched){
                  $(card).flip(false);
                }
              });
              currentlyFlipped = [];
            }, 1000);
          }
        }
        $("#score").text("Score: "+calculateScore(elapsedTime.secs+60*elapsedTime.mins, flipCounter, matches));
      });
    });

    function renderBoard(board){
      for (var key in board){
        if (key != 'size'){
          var square = '<li class="square" id='+board[key][1][0]+' data-language='+board[key][1][1]+'><div class="front">'+board[key][1][0]+'</div><div class="back">'+board[key][0].text+'</div></li>';
          $(".board").append(square);
        }
      };
    };

  </script>
</body>
</html>